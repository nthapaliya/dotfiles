#!/usr/bin/env bash

set -euo pipefail

source "$HOME/creds.bash"

REV=${1:-HEAD}
HASH=$(git rev-parse "$REV")

URL="$( git config --list |\
  sed -nEe 's/^remote.origin.url=(https:\/\/github.com\/|git@github.com:)([^.]+)(\.git)?/\2/p' )"
OWNER=$(echo "$URL" | cut -d / -f 1)
REPO_NAME=$(echo "$URL" | cut -d / -f 2)

QUERY="
{
  repository(owner: \\\"$OWNER\\\", name: \\\"$REPO_NAME\\\") {
    object(expression: \\\"$HASH\\\") {
      ... on Commit {
        status {
          state
          contexts {
            state
            targetUrl
          }
        }
      }
    }
  }
}
"

URL=$( \
  curl -s \
    -H "Authorization: bearer $GITHUB_API_KEY" \
    -X POST \
    --data "{ \"query\": \"query $(echo -n $QUERY) \" }" \
    https://api.github.com/graphql |
  jq -r .data.repository.object.status.contexts[0].targetUrl \
  )


if [[ "$URL" != "null" ]]; then
  open "$URL"
else
  exit 1
fi
