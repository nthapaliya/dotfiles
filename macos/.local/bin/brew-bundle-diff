#!/usr/bin/env ruby

require 'open3'

DOTFILES_DIR = File.expand_path('~/Projects/dotfiles/')
BREWFILE = 'macos/.Brewfile'.freeze

def brewfile_git_info
  command = "git log --follow -n1 --pretty=format:'%ar' #{BREWFILE}"
  output, status = Open3.capture2(command)
  abort unless status.success?
  puts "Last commit was #{output}"
  puts
end

def update_brewfile
  command = 'brew bundle dump --force --global'
  _, status = Open3.capture2(command)
  abort unless status.success?
end

def lines
  command = "git diff --word-diff=porcelain -- #{BREWFILE}"
  raw_diff, status = Open3.capture2(command)
  abort unless status.success?

  raw_diff
    .chomp
    .delete("\n")
    .split('~')
    .map(&:strip)
    .select { |line| line.start_with?('+', '-') }
end

def parse_diffed_lines
  additions = lines
              .select { |line| line.start_with?('+') }
              .map { |line| line.delete('+') }
  subtractions = lines
                 .select { |line| line.start_with?('-') }
                 .map { |line| line.delete('-') }

  [additions, subtractions]
end

Dir.chdir(DOTFILES_DIR)
update_brewfile
brewfile_git_info
additions, subtractions = parse_diffed_lines

puts 'True Additions'
puts additions - subtractions
puts

puts 'True subtractions'
puts subtractions - additions
puts

puts 'Rearranges'
puts additions & subtractions
